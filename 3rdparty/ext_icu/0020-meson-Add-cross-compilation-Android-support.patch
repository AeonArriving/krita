From 70df2369bcbe364781bf28eb1629eb9adc6634d3 Mon Sep 17 00:00:00 2001
From: "L. E. Segovia" <amy@amyspark.me>
Date: Sat, 19 Nov 2022 00:52:35 +0000
Subject: [PATCH 20/20] meson: Add cross-compilation (Android) support

---
 meson.build                       |  4 ++++
 source/common/meson.build         | 22 ++++++++++++++++++++++
 source/data/meson.build           |  2 +-
 source/i18n/meson.build           | 21 +++++++++++++++++++++
 source/stubdata/meson.build       | 14 ++++++++++++++
 source/tools/genccode/meson.build | 11 +++++++++++
 source/tools/toolutil/meson.build | 19 +++++++++++++++++++
 7 files changed, 92 insertions(+), 1 deletion(-)

diff --git a/meson.build b/meson.build
index 4a83256..86791ff 100644
--- a/meson.build
+++ b/meson.build
@@ -12,6 +12,8 @@ PACKAGE_ICU_DESCRIPTION = 'International Components for Unicode'
 PACKAGE_ICU_URL = 'http://icu-project.org'
 
 cpp = meson.get_compiler('cpp')
+cpp_native = meson.get_compiler('cpp', native: true)
+
 have_elf_h = cpp.has_header('elf.h')
 
 if host_machine.system() == 'windows'
@@ -28,8 +30,10 @@ endif
 
 if meson.version().version_compare('>= 0.62')
   dl_dep = dependency('dl', required: false)
+  dl_native_dep = dependency('dl', required: false, native: true)
 else
   dl_dep = cpp.find_library('dl', required: false)
+  dl_native_dep = cpp_native.find_library('dl', required: false, native: true)
 endif
 
 windows = import('windows')
diff --git a/source/common/meson.build b/source/common/meson.build
index c9ff6cf..234f41c 100644
--- a/source/common/meson.build
+++ b/source/common/meson.build
@@ -212,12 +212,34 @@ common_lib = library(
   install: true,
 )
 
+if meson.can_run_host_binaries()
+  common_native_lib = common_lib
+else
+  common_native_lib = library(
+    '@0@-native'.format(icuuc_name),
+    sources,
+    include_directories: incdir,
+    c_args: '-DU_COMMON_IMPLEMENTATION',
+    cpp_args: '-DU_COMMON_IMPLEMENTATION',
+    link_with: stubdata_native_lib,
+    dependencies: dl_native_dep,
+    version: U_ICU_VERSION,
+    native: true,
+  )
+endif
+
 icuuc_dep = declare_dependency(
   link_with: common_lib,
   compile_args: usage_args,
   include_directories: incdir,
 )
 
+icuuc_native_dep = declare_dependency(
+  link_with: common_native_lib,
+  compile_args: usage_args,
+  include_directories: incdir,
+)
+
 if meson.version().version_compare('>=0.54.0')
   meson.override_dependency('icu-uc', icuuc_dep)
 endif
diff --git a/source/data/meson.build b/source/data/meson.build
index 9f2a907..80127d6 100644
--- a/source/data/meson.build
+++ b/source/data/meson.build
@@ -1,7 +1,7 @@
 U_ICUDATA_NAME = 'icudt@0@'.format(U_ICU_VERSION.split('.')[0])
 
 icudata_command = [
-  genccode_exe, '-d', '@OUTDIR@', '-e', U_ICUDATA_NAME, '-f', U_ICUDATA_NAME, '@CURRENT_SOURCE_DIR@/in/@0@l.dat'.format(U_ICUDATA_NAME)
+  genccode_native_exe, '-d', '@OUTDIR@', '-e', U_ICUDATA_NAME, '-f', U_ICUDATA_NAME, '@CURRENT_SOURCE_DIR@/in/@0@l.dat'.format(U_ICUDATA_NAME)
 ]
 
 if host_machine.system() == 'windows' and get_option('default_library') == 'static'
diff --git a/source/i18n/meson.build b/source/i18n/meson.build
index 4c81ddf..fb30a2f 100644
--- a/source/i18n/meson.build
+++ b/source/i18n/meson.build
@@ -275,12 +275,33 @@ i18n_lib = library(
   install: true,
 )
 
+if meson.can_run_host_binaries()
+  i18n_native_lib = i18n_lib
+else
+  i18n_native_lib = library(
+    '@0@-native'.format(i18n_name),
+    sources,
+    include_directories: incdir,
+    link_with: [common_native_lib],
+    c_args: '-DU_I18N_IMPLEMENTATION',
+    cpp_args: '-DU_I18N_IMPLEMENTATION',
+    version: U_ICU_VERSION,
+    native: true,
+  )
+endif
+
 icui18n_dep = declare_dependency(
   link_with: [i18n_lib, common_lib],
   compile_args: usage_args,
   include_directories: incdir,
 )
 
+icui18n_native_dep = declare_dependency(
+  link_with: [i18n_native_lib, common_native_lib],
+  compile_args: usage_args,
+  include_directories: incdir,
+)
+
 if meson.version().version_compare('>=0.54.0')
   meson.override_dependency('icu-i18n', icui18n_dep)
 endif
diff --git a/source/stubdata/meson.build b/source/stubdata/meson.build
index 76912bd..0bbb325 100644
--- a/source/stubdata/meson.build
+++ b/source/stubdata/meson.build
@@ -17,3 +17,17 @@ stubdata_lib = library(
   include_directories: incdir,
   version: U_ICU_VERSION,
 )
+
+if meson.can_run_host_binaries()
+  stubdata_native_lib = stubdata_lib
+else
+  stubdata_native_lib = library(
+    '@0@-native'.format(icudata_name),
+    sources,
+    c_args: '-DSTUBDATA_BUILD',
+    cpp_args: '-DSTUBDATA_BUILD',
+    include_directories: incdir,
+    version: U_ICU_VERSION,
+    native: true,
+  )
+endif
diff --git a/source/tools/genccode/meson.build b/source/tools/genccode/meson.build
index c10788a..9995bcc 100644
--- a/source/tools/genccode/meson.build
+++ b/source/tools/genccode/meson.build
@@ -5,4 +5,15 @@ genccode_exe = executable(
   install: true,
 )
 
+if meson.can_run_host_binaries()
+  genccode_native_exe = genccode_exe
+else
+  genccode_native_exe = executable(
+    'genccode-native',
+    'genccode.c',
+    dependencies: [toolutil_native_dep, icuuc_native_dep],
+    native: true,
+  )
+endif
+
 meson.override_find_program('genccode', genccode_exe)
diff --git a/source/tools/toolutil/meson.build b/source/tools/toolutil/meson.build
index 82101cb..0307b23 100644
--- a/source/tools/toolutil/meson.build
+++ b/source/tools/toolutil/meson.build
@@ -42,7 +42,26 @@ toolutil_lib = library(
   link_with: [i18n_lib, common_lib],
 )
 
+if meson.can_run_host_binaries()
+  toolutil_native_lib = toolutil_lib
+else
+  toolutil_native_lib = library(
+    'toolutil-native',
+    sources,
+    include_directories: incdir,
+    c_args: toolutil_c_args,
+    cpp_args: toolutil_cpp_args,
+    link_with: [i18n_native_lib, common_native_lib],
+    native: true,
+  )
+endif
+
 toolutil_dep = declare_dependency(
   link_with: toolutil_lib,
   include_directories: include_directories('.'),
 )
+
+toolutil_native_dep = declare_dependency(
+  link_with: toolutil_native_lib,
+  include_directories: include_directories('.'),
+)
-- 
2.38.1

