From 61ee93a49a36b6bc82f94071a1ce0bfa8e454791 Mon Sep 17 00:00:00 2001
From: "L. E. Segovia" <amy@amyspark.me>
Date: Thu, 17 Nov 2022 18:06:39 -0300
Subject: [PATCH 16/18] meson: Fix missing icudata library export for MSVC

---
 source/data/export_module.py | 17 +++++++++++++++++
 source/data/meson.build      | 12 ++++++++++++
 2 files changed, 29 insertions(+)
 create mode 100644 source/data/export_module.py

diff --git a/source/data/export_module.py b/source/data/export_module.py
new file mode 100644
index 0000000..d29b1c8
--- /dev/null
+++ b/source/data/export_module.py
@@ -0,0 +1,17 @@
+#!/usr/bin/env python3
+# SPDX-FileCopyrightText: 2022 L. E. Segovia <amy@amyspark.me>
+# SPDX-License-Identifier: MIT
+
+from argparse import ArgumentParser, FileType
+from sys import stdout
+
+if __name__ == '__main__':
+    parser = ArgumentParser()
+    parser.add_argument('symbol', type=str, help='Symbol to export')
+    parser.add_argument('outfile', nargs='?', type=FileType('w', encoding='utf-8'),
+        default=stdout, help='Module definition file')
+    args = parser.parse_args()
+
+    with args.outfile as f:
+        f.write("EXPORTS\n")
+        f.write(f"\t{args.symbol}\n")
diff --git a/source/data/meson.build b/source/data/meson.build
index 342952d..9f2a907 100644
--- a/source/data/meson.build
+++ b/source/data/meson.build
@@ -43,6 +43,17 @@ icudata_asm = custom_target(
 
 sources = [icudata_asm]
 
+python_exe = import('python').find_installation('python3')
+
+icudata_exports = custom_target(
+  'icudata_exports',
+  command: [
+    python_exe, '@INPUT@', '@0@_dat'.format(U_ICUDATA_NAME), '@OUTDIR@/module.def'
+  ],
+  input: 'export_module.py',
+  output: 'module.def'
+)
+
 if host_machine.system() == 'windows'
   sources += windows.compile_resources(
     'misc/icudata.rc',
@@ -55,6 +66,7 @@ icudata = library(
     sources,
     include_directories: incdir,
     version: U_ICU_VERSION,
+    vs_module_defs: icudata_exports,
     install: true,
 )
 
-- 
2.37.1.windows.1

