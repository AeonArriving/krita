From 530d8fd000b8559e067960229173e07815f3b11d Mon Sep 17 00:00:00 2001
From: "L. E. Segovia" <amy@amyspark.me>
Date: Sat, 26 Nov 2022 00:36:07 +0000
Subject: [PATCH 4/8] theora: Add examples

---
 examples/meson.build | 107 +++++++++++++++++++++++++++++++++++++++++++
 meson.build          |  36 +++++++++++++++
 meson_options.txt    |   1 +
 3 files changed, 144 insertions(+)
 create mode 100644 examples/meson.build

diff --git a/examples/meson.build b/examples/meson.build
new file mode 100644
index 0000000..c065bb9
--- /dev/null
+++ b/examples/meson.build
@@ -0,0 +1,107 @@
+theora_libs = [libtheora]
+theoradec_libs = [libtheoradec]
+theoraenc_libs = [libtheoraenc, libtheoradec]
+
+compat_dep = dependency('compat', required: host_machine.system() == 'openbsd')
+
+if cc.has_header_symbol('unistd.h', 'getopt_long')
+    getopt_dep = disabler()
+else
+    if cc.get_id() == 'msvc'
+        getopt_sources = files(
+            '../win32/getopt.c',
+            '../win32/getopt1.c',
+        ),
+        getopt_incdir = include_directories('../win32/')
+    else
+        getopt_sources = files(
+            'getopt.c',
+            'getopt1.c',
+        )
+        getopt_incdir = include_directories('.')
+    endif
+
+
+    getopt_dep = declare_dependency(
+        sources: getopt_sources,
+        dependencies: config_dep,
+        include_directories: getopt_incdir
+    )
+endif
+
+dump_video_sources = files(
+    'dump_video.c',
+)
+
+dump_video = executable(
+    'dump_video',
+    dump_video_sources,
+    link_with: theoradec_libs,
+    dependencies: [compat_dep, getopt_dep],
+)
+
+dump_psnr_sources = files(
+    'dump_psnr.c',
+)
+
+dump_psnr = executable(
+    'dump_psnr',
+    dump_psnr_sources,
+    link_with: theoradec_libs,
+    dependencies: [m_dep, getopt_dep],
+)
+
+libtheora_info_sources = files(
+    'libtheora_info.c',
+)
+
+libtheora_info = executable(
+    'libtheora_info',
+    libtheora_info_sources,
+    link_with: theoradec_libs,
+    dependencies: [config_dep],
+)
+
+player_example_sources = files(
+    'player_example.c',
+)
+
+player_example = executable(
+    'player_example',
+    player_example_sources,
+    link_with: theoradec_libs,
+    dependencies: [sdl_dep, vorbis_dep, oss_dep, m_dep, getopt_dep, config_dep],
+)
+
+encoder_example_sources = files(
+    'encoder_example.c',
+)
+
+encoder_example = executable(
+    'encoder_example',
+    encoder_example_sources,
+    link_with: theoraenc_libs,
+    dependencies: [ogg_dep, vorbis_dep, vorbisenc_dep, m_dep, getopt_dep],
+)
+
+png2theora_sources = files(
+    'png2theora.c',
+)
+
+png2theora = executable(
+    'png2theora',
+    png2theora_sources,
+    link_with: theoraenc_libs,
+    dependencies: [ogg_dep, png_dep, m_dep, getopt_dep, config_dep],
+)
+
+tiff2theora_sources = files(
+    'tiff2theora.c',
+)
+
+tiff2theora = executable(
+    'tiff2theora',
+    tiff2theora_sources,
+    link_with: theoraenc_libs,
+    dependencies: [ogg_dep, tiff_dep, m_dep, getopt_dep, config_dep],
+)
diff --git a/meson.build b/meson.build
index ba2465c..ba1c2ee 100644
--- a/meson.build
+++ b/meson.build
@@ -54,6 +54,38 @@ ogg_dep = dependency('ogg',
 
 vorbis_dep = dependency('vorbis', version: '>= 1.0.1', required: false)
 
+sdl_dep = dependency('sdl', required: false)
+
+if not sdl_dep.found()
+    warning('*** Unable to find SDL -- Not compiling example players ***')
+endif
+
+if cc.has_header('sys/soundcard.h') or cc.has_header('soundcard.h') or cc.has_header('machine/soundcard.h')
+    if host_machine.system() == 'openbsd'
+        oss_dep = dependency('ossaudio', required: false, disabler: true)
+    else
+        oss_dep = declare_dependency()
+    endif
+else
+    oss_dep = disabler()
+endif
+
+if not oss_dep.found()
+    warning('OSS audio support not found -- not compiling player_example')
+endif
+
+libpng_dep = dependency('libpng', required: false)
+
+tiff_dep = dependency('tiff', required: false, disabler: true)
+
+if tiff_dep.found() and not cc.has_header_symbol(
+        'tiffio.h',
+        'TIFFReadRGBAImage',
+        dependencies: tiff_dep
+    )
+    tiff_dep = disabler()
+endif
+
 asm = get_option('asm').allowed()
 enable_asflag_probe = get_option('asflag-probe').allowed()
 if asm 
@@ -151,6 +183,10 @@ subdir('include')
 
 subdir('lib')
 
+if get_option('examples').enabled()
+    subdir('examples')
+endif
+
 subdir('tests')
 
 theora_dep = declare_dependency(
diff --git a/meson_options.txt b/meson_options.txt
index 26b839b..fbe95c0 100644
--- a/meson_options.txt
+++ b/meson_options.txt
@@ -1,4 +1,5 @@
 option('valgrind-testing', type: 'feature', value: 'disabled', description: 'Enable running of tests inside Valgrind')
 option('asm', type: 'feature', value: 'enabled', description: 'Enable assembly optimizations')
 option('asflag-probe', type: 'feature', value: 'enabled', description: 'Enable instructions not supported by the default assembler flags (Arm only).')
+option('examples', type: 'feature', value: 'disabled', description: 'Enable examples')
 option('collect-metrics', type: 'feature', value: 'disabled', description: 'Enable metrics collection for mode training')
-- 
2.37.1.windows.1

